@model IList<CommentDto>

<div class="comments-section mt-4">
    <h6 class="mb-3">Comments (@Model.Count)</h6>

    <div class="comments-list" id="comments-container">
        @foreach (var comment in Model.OrderByDescending(c => c.CreatedAt))
        {
            <div class="card mb-3" data-comment-id="@comment.Id">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>@comment.UserName</strong>
                            <br>
                            <small class="text-muted">@comment.CreatedAt.ToString("MMM dd, HH:mm")</small>
                            @if (comment.IsEdited)
                            {
                                <small class="text-muted ms-2">(edited)</small>
                            }
                        </div>
                        <div class="comment-actions">
                            <button class="btn btn-sm btn-link" onclick="editCommentUI(@comment.Id)" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-danger" onclick="deleteComment(@comment.Id)" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>

                    <p class="comment-content mb-0" id="comment-text-@comment.Id">@Html.Raw(comment.Content)</p>
                    
                    <!-- Edit form (hidden by default) -->
                    <form class="d-none mt-2" id="edit-form-@comment.Id" 
                          onsubmit="updateComment(event, @comment.Id)">
                        <textarea class="form-control" id="edit-text-@comment.Id" 
                                  rows="3" required>@comment.Content</textarea>
                        <div class="mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-secondary" 
                                    onclick="cancelEditComment(@comment.Id)">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        }
    </div>

    <!-- Add Comment Form -->
    <form class="mt-4" onsubmit="addCommentHandler(event, @ViewBag.TaskId)">
        <div class="form-group">
            <label for="comment-text-new" class="form-label">Add a comment</label>
            <textarea class="form-control" id="comment-text-new" placeholder="Write your comment..." 
                      rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Post Comment</button>
    </form>
</div>

<script>
    function editCommentUI(commentId) {
        document.getElementById('comment-text-' + commentId).classList.add('d-none');
        document.getElementById('edit-form-' + commentId).classList.remove('d-none');
        document.getElementById('edit-text-' + commentId).focus();
    }

    function cancelEditComment(commentId) {
        document.getElementById('comment-text-' + commentId).classList.remove('d-none');
        document.getElementById('edit-form-' + commentId).classList.add('d-none');
    }

    function addCommentHandler(event, taskId) {
        event.preventDefault();
        const content = document.getElementById('comment-text-new').value.trim();
        if (content) {
            addComment(taskId, content);
            document.getElementById('comment-text-new').value = '';
        }
    }

    function updateComment(event, commentId) {
        event.preventDefault();
        const content = document.getElementById('edit-text-' + commentId).value.trim();
        if (content) {
            updateCommentAsync(commentId, content);
        }
    }
</script>
